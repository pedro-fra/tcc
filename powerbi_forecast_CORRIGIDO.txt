// ========================================
// VERSAO CORRIGIDA - USA RELACIONAMENTO INATIVO
// ========================================

// IMPORTANTE: O relacionamento ativo e com DATE_CAD
// Mas queremos usar DATA_EMISSAO_PEDIDO (relacionamento inativo)
// Precisamos usar USERELATIONSHIP para ativar o relacionamento correto

// 1. ULTIMA DATA COM FATURAMENTO (USA DATA_EMISSAO_PEDIDO)
Ultima Data Global v2 =
CALCULATE(
    MAX('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
    REMOVEFILTERS(),
    USERELATIONSHIP('[Dim] Calendário'[Data], '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
    '[Fato] Faturamento'[GERA_COBRANCA] = 1,
    '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"},
    '[Fato] Faturamento'[VALOR_LIQ] > 0
)

// 2. MEDIA DIARIA (USA DATA_EMISSAO_PEDIDO)
Media Diaria Global v2 =
VAR UltimaDataVenda = [Ultima Data Global v2]
VAR Ultimos30Dias = UltimaDataVenda - 30

VAR SomaVendas =
    CALCULATE(
        SUM('[Fato] Faturamento'[VALOR_LIQ]),
        REMOVEFILTERS(),
        USERELATIONSHIP('[Dim] Calendário'[Data], '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > Ultimos30Dias,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

VAR DiasComVenda =
    CALCULATE(
        DISTINCTCOUNT('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
        REMOVEFILTERS(),
        USERELATIONSHIP('[Dim] Calendário'[Data], '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > Ultimos30Dias,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

RETURN
DIVIDE(SomaVendas, DiasComVenda, 0)

// 3. VALOR FATURAMENTO (USA DATA_EMISSAO_PEDIDO COM RELACIONAMENTO INATIVO)
Valor Faturamento v2 =
CALCULATE(
    SUM('[Fato] Faturamento'[VALOR_LIQ]),
    USERELATIONSHIP('[Dim] Calendário'[Data], '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
    '[Fato] Faturamento'[GERA_COBRANCA] = 1,
    '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
)

// 4. FATURAMENTO PROJETADO (USA DATA_EMISSAO_PEDIDO)
Faturamento Projetado CORRIGIDO =
VAR DataLinha = MAX('[Dim] Calendário'[Data])
VAR DiaSemana = MAX('[Dim] Calendário'[NomeDia])
VAR EhFeriado = MAX('[Dim] Calendário'[Feriado])
VAR UltimaDataVenda = [Ultima Data Global v2]
VAR MediaDiaria = [Media Diaria Global v2]

// Se nao conseguir pegar a data, retorna BLANK
VAR DataOK = NOT(ISBLANK(DataLinha))

// Verifica se e dia util
VAR EhDiaUtil =
    DiaSemana <> "SÁBADO" &&
    DiaSemana <> "DOMINGO" &&
    EhFeriado = "Não"

// Converte datas para numero (remove horario)
VAR DataLinhaNum = INT(DataLinha)
VAR UltimaDataNum = INT(UltimaDataVenda)

// Determina se e passado ou futuro
VAR EhPassado = DataLinhaNum <= UltimaDataNum

VAR Resultado =
    IF(
        NOT(DataOK), BLANK(),
        IF(
            NOT(EhDiaUtil), BLANK(),
            IF(
                EhPassado,
                [Valor Faturamento v2],
                MediaDiaria
            )
        )
    )

RETURN Resultado

// ========================================
// DEBUG ATUALIZADO
// ========================================
Debug - Status v2 =
VAR DataLinha = MAX('[Dim] Calendário'[Data])
VAR UltimaDataVenda = [Ultima Data Global v2]
VAR DataLinhaNum = INT(DataLinha)
VAR UltimaDataNum = INT(UltimaDataVenda)
VAR EhPassado = DataLinhaNum <= UltimaDataNum
VAR MediaDiaria = [Media Diaria Global v2]
VAR ValorFat = [Valor Faturamento v2]

RETURN
"Data: " & FORMAT(DataLinha, "DD/MM/YYYY") &
" (" & DataLinhaNum & ")" &
" | Ultima: " & FORMAT(UltimaDataVenda, "DD/MM/YYYY") &
" (" & UltimaDataNum & ")" &
" | Status: " & IF(EhPassado, "PASSADO", "FUTURO") &
" | Valor: " & ValorFat &
" | Media: " & ROUND(MediaDiaria, 2)

// ========================================
// INSTRUCOES
// ========================================
// 1. Crie TODAS as 5 medidas acima:
//    - Ultima Data Global v2
//    - Media Diaria Global v2
//    - Valor Faturamento v2
//    - Faturamento Projetado CORRIGIDO
//    - Debug - Status v2
//
// 2. Use "Faturamento Projetado CORRIGIDO" na tabela
//
// 3. Verifique com "Debug - Status v2" se agora:
//    - 01/10 e 02/10: PASSADO com valores reais
//    - 03/10 em diante: FUTURO com media diaria (~23280)
//
// IMPORTANTE: Todas as medidas agora usam USERELATIONSHIP para
// ativar o relacionamento inativo com DATA_EMISSAO_PEDIDO
