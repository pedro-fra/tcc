// ========================================
// VERSAO FINAL - COMPLETAMENTE REESCRITA
// ========================================

// 1. ULTIMA DATA COM FATURAMENTO (GLOBAL)
Ultima Data Global =
CALCULATE(
    MAX('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
    REMOVEFILTERS('[Dim] Calendário'),
    REMOVEFILTERS('[Fato] Faturamento'),
    '[Fato] Faturamento'[GERA_COBRANCA] = 1,
    '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"},
    '[Fato] Faturamento'[VALOR_LIQ] > 0
)

// 2. MEDIA DIARIA DOS ULTIMOS 30 DIAS
Media Diaria Global =
VAR UltimaDataVenda = [Ultima Data Global]
VAR Ultimos30Dias = UltimaDataVenda - 30

VAR SomaVendas =
    CALCULATE(
        SUM('[Fato] Faturamento'[VALOR_LIQ]),
        REMOVEFILTERS('[Dim] Calendário'),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > Ultimos30Dias,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

VAR DiasComVenda =
    CALCULATE(
        DISTINCTCOUNT('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
        REMOVEFILTERS('[Dim] Calendário'),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > Ultimos30Dias,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

RETURN
DIVIDE(SomaVendas, DiasComVenda, 0)

// 3. FATURAMENTO PROJETADO FINAL
Faturamento Projetado FINAL =
VAR DataLinha = MAX('[Dim] Calendário'[Data])
VAR DiaSemana = MAX('[Dim] Calendário'[NomeDia])
VAR EhFeriado = MAX('[Dim] Calendário'[Feriado])
VAR UltimaDataVenda = [Ultima Data Global]
VAR MediaDiaria = [Media Diaria Global]

// Verifica se e dia util
VAR EhDiaUtil =
    DiaSemana <> "SÁBADO" &&
    DiaSemana <> "DOMINGO" &&
    EhFeriado = "Não"

// Converte datas para numero (remove horario)
VAR DataLinhaNum = INT(DataLinha)
VAR UltimaDataNum = INT(UltimaDataVenda)

// Determina se e passado ou futuro
VAR EhPassado = DataLinhaNum <= UltimaDataNum

VAR Resultado =
    SWITCH(
        TRUE(),
        // Se nao for dia util, retorna BLANK
        NOT(EhDiaUtil), BLANK(),
        // Se for passado, retorna valor real
        EhPassado, [Valor Faturamento],
        // Se for futuro, retorna projecao (media diaria)
        MediaDiaria
    )

RETURN Resultado

// ========================================
// MEDIDA DE DEBUG ATUALIZADA
// ========================================
Debug - Status FINAL =
VAR DataLinha = MAX('[Dim] Calendário'[Data])
VAR UltimaDataVenda = [Ultima Data Global]
VAR DataLinhaNum = INT(DataLinha)
VAR UltimaDataNum = INT(UltimaDataVenda)
VAR EhPassado = DataLinhaNum <= UltimaDataNum
VAR MediaDiaria = [Media Diaria Global]
VAR ValorFat = [Valor Faturamento]

RETURN
"Data Linha: " & FORMAT(DataLinha, "DD/MM/YYYY") &
" (" & DataLinhaNum & ")" &
" | Ultima: " & FORMAT(UltimaDataVenda, "DD/MM/YYYY") &
" (" & UltimaDataNum & ")" &
" | Status: " & IF(EhPassado, "PASSADO", "FUTURO") &
" | Valor: " & ValorFat &
" | Media: " & ROUND(MediaDiaria, 2)

// ========================================
// INSTRUCOES
// ========================================
// 1. Crie as 3 medidas principais:
//    - Ultima Data Global
//    - Media Diaria Global
//    - Faturamento Projetado FINAL
//
// 2. Crie a medida de debug:
//    - Debug - Status FINAL
//
// 3. Teste na tabela e verifique:
//    - 01/10 e 02/10: devem mostrar valores reais
//    - 03/10 em diante: devem mostrar media diaria (~25768)
//    - Sabados/Domingos: devem mostrar BLANK
//
// 4. Use "Debug - Status FINAL" para confirmar que:
//    - DataLinhaNum aumenta a cada dia
//    - UltimaDataNum e sempre o mesmo (45202 ou similar)
//    - Status muda de PASSADO para FUTURO no dia 03/10
