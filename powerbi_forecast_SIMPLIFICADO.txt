// ========================================
// VERSAO SIMPLIFICADA - MAIS ROBUSTA
// ========================================
// Use esta versao se a hibrida nao funcionar

// 1. ULTIMA DATA COM FATURAMENTO (VERSAO SIMPLIFICADA)
Ultima Data Faturamento v2 =
CALCULATE(
    MAX('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
    '[Fato] Faturamento'[GERA_COBRANCA] = 1,
    '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"},
    '[Fato] Faturamento'[VALOR_LIQ] > 0
)

// 2. MEDIA DIARIA SIMPLIFICADA (ultimos 30 dias com vendas)
Media Diaria v2 =
VAR UltimaDataVenda = [Ultima Data Faturamento v2]
VAR DataInicio = UltimaDataVenda - 30

VAR TotalVendas =
    CALCULATE(
        SUM('[Fato] Faturamento'[VALOR_LIQ]),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > DataInicio,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

VAR DiasComVenda =
    CALCULATE(
        DISTINCTCOUNT('[Fato] Faturamento'[DATA_EMISSAO_PEDIDO]),
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] > DataInicio,
        '[Fato] Faturamento'[DATA_EMISSAO_PEDIDO] <= UltimaDataVenda,
        '[Fato] Faturamento'[GERA_COBRANCA] = 1,
        '[Fato] Faturamento'[OPERACAO] IN {"VENDA", "VENDA DE MERCADORIA CONSIGNADA"}
    )

RETURN
DIVIDE(TotalVendas, DiasComVenda, 0)

// 3. FATURAMENTO PROJETADO SIMPLIFICADO
Faturamento Projetado Simplificado =
VAR DataAtual = SELECTEDVALUE('[Dim] Calendário'[Data])
VAR DiaSemana = SELECTEDVALUE('[Dim] Calendário'[NomeDia])
VAR EhFeriado = SELECTEDVALUE('[Dim] Calendário'[Feriado])
VAR UltimaDataVenda = [Ultima Data Faturamento v2]

// Se for final de semana ou feriado, retorna BLANK
VAR EhDiaUtil =
    DiaSemana <> "SÁBADO" &&
    DiaSemana <> "DOMINGO" &&
    EhFeriado = "Não"

VAR Resultado =
    IF(
        NOT(EhDiaUtil),
        BLANK(),
        IF(
            DataAtual <= UltimaDataVenda,
            // Passado: retorna valor real
            [Valor Faturamento],
            // Futuro: retorna projecao baseada na media diaria
            [Media Diaria v2]
        )
    )

RETURN Resultado

// ========================================
// INSTRUCOES
// ========================================
// 1. Crie as 3 medidas acima no Power BI
// 2. Teste a medida "Faturamento Projetado Simplificado"
// 3. Verifique se:
//    - Datas passadas mostram valor real
//    - Datas futuras mostram valor projetado (diferente do real)
//    - Finais de semana mostram BLANK
